---
# Certificate issued by cert-manager
# Requires cert-manager to be installed in the cluster
apiVersion: cert-manager.io/v1
kind: Certificate
metadata:
  name: node-cleanup-webhook
  namespace: node-cleanup-system
spec:
  secretName: node-cleanup-webhook-tls
  duration: 8760h  # 1 year
  renewBefore: 720h  # 30 days
  subject:
    organizations:
      - "infra.894.io"
  isCA: false
  privateKey:
    algorithm: RSA
    size: 2048
  usages:
    - server auth
  dnsNames:
    - node-cleanup-webhook
    - node-cleanup-webhook.node-cleanup-system
    - node-cleanup-webhook.node-cleanup-system.svc
    - node-cleanup-webhook.node-cleanup-system.svc.cluster.local
  issuerRef:
    name: selfsigned-issuer
    kind: ClusterIssuer
    group: cert-manager.io

---
# Self-signed ClusterIssuer (create this once per cluster if not exists)
# You may already have a ClusterIssuer - adjust issuerRef above accordingly
apiVersion: cert-manager.io/v1
kind: ClusterIssuer
metadata:
  name: selfsigned-issuer
spec:
  selfSigned: {}

---
# MutatingWebhookConfiguration
# The caBundle will be injected by cert-manager
apiVersion: admissionregistration.k8s.io/v1
kind: MutatingWebhookConfiguration
metadata:
  name: node-cleanup-webhook
  annotations:
    # cert-manager will inject the CA bundle
    cert-manager.io/inject-ca-from: node-cleanup-system/node-cleanup-webhook
  labels:
    app.kubernetes.io/name: node-cleanup-webhook
webhooks:
  - name: node-cleanup.infra.894.io
    
    # Only intercept Node CREATE operations
    rules:
      - apiGroups: [""]
        apiVersions: ["v1"]
        operations: ["CREATE"]
        resources: ["nodes"]
        scope: "Cluster"
    
    clientConfig:
      service:
        name: node-cleanup-webhook
        namespace: node-cleanup-system
        path: /mutate-node
        port: 443
      # caBundle will be injected by cert-manager
    
    admissionReviewVersions: ["v1"]
    sideEffects: None
    
    # Fail open - if webhook is unavailable, allow the node creation
    # This prevents webhook issues from blocking cluster operations
    failurePolicy: Ignore
    
    # Match all nodes (no namespace selector needed for cluster-scoped resources)
    matchPolicy: Equivalent
    
    # Timeout for webhook call
    timeoutSeconds: 10
    
    # Reinvocation policy - only call once
    reinvocationPolicy: Never
